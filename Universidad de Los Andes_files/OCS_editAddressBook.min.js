define(["knockout","pubsub","navigation","viewModels/address","notifier","ccConstants","CCi18n"],function(e,t,n,r,i,s,o){"use strict";return{WIDGET_ID:"addressBook",ignoreBlur:e.observable(!1),isUserProfileShippingEdited:e.observable(!1),isUserProfileDefaultAddressEdited:e.observable(!1),interceptedLink:e.observable(null),isUserProfileInvalid:e.observable(!1),isProfileLocaleNotInSupportedLocales:e.observable(),beforeAppear:function(e){var r=this;$.Topic(t.topicNames.DISCARD_ADDRESS_CHANGES).subscribe(r.handleCancelUpdateForAddressBook),r.user().loggedIn()==0?n.doLogin(n.getPath(),r.links().home.route):r.user().isSessionExpiredDuringSave()?r.user().isSessionExpiredDuringSave(!1):(r.user().resetPassword(),r.showViewProfile(!0),i.clearError(r.WIDGET_ID),i.clearSuccess(r.WIDGET_ID),r.user().isUserProfileEdited(!1))},onLoad:function(o){var u=this,a=e.observable(!1),f=e.observable(null),l=e.observable(!1);o.ErrorMsg=o.translate("updateErrorMsg"),o.passwordErrorMsg=o.translate("passwordUpdateErrorMsg"),o.showViewProfile=function(e){e&&o.user().getCurrentUser(!1),o.isUserProfileShippingEdited(!1),o.isUserProfileDefaultAddressEdited(!1)},o.reloadShipping=function(){if(o.user().updatedShippingAddressBook){var e=[];for(var t=0;t<o.user().updatedShippingAddressBook.length;t++){var n=new r("user-shipping-address",o.ErrorMsg,o,o.shippingCountries(),o.defaultShippingCountry());n.countriesList(o.shippingCountries()),n.copyFrom(o.user().updatedShippingAddressBook[t],o.shippingCountries()),n.resetModified(),n.country(o.user().updatedShippingAddressBook[t].countryName),n.state(o.user().updatedShippingAddressBook[t].regionName),e.push(n)}o.user().shippingAddressBook(e)}},o.handleMouseUp=function(){return this.ignoreBlur(!1),!0},o.handleMouseDown=function(){return this.ignoreBlur(!0),!0},o.hideModal=function(){if(a()||o.user().isSearchInitiatedWithUnsavedChanges())$("#CC-customerProfile-modal-3").modal("hide"),$("body").removeClass("modal-open"),$(".modal-backdrop").remove()},o.showModal=function(){$("#CC-customerProfile-modal-3").modal("show"),a(!0)},o.handleCancelUpdateForAddressBook=function(){o.showViewProfile(!0),o.user().editShippingAddress(null),o.reloadShipping(),i.clearError(o.WIDGET_ID),i.clearSuccess(o.WIDGET_ID),o.user().isUserProfileEdited(!1),o.hideModal()},o.handleModalCancelUpdateDiscard=function(){o.handleCancelUpdateForAddressBook(),o.user().isSearchInitiatedWithUnsavedChanges()?(o.hideModal(),o.user().isSearchInitiatedWithUnsavedChanges(!1)):o.navigateAway()},o.handleCreateShippingAddress=function(){var e=new r("user-shipping-address",o.ErrorMsg,o,o.shippingCountries(),o.defaultShippingCountry());o.editShippingAddress(e)},o.editShippingAddress=function(e){o.user().isUserProfileEdited(!0),i.clearError(o.WIDGET_ID),i.clearSuccess(o.WIDGET_ID),o.user().editShippingAddress(e),o.isUserProfileShippingEdited(!0),$("#CC-customerProfile-sfirstname").focus(),o.shippingCountries().length==0&&$("#CC-customerProfile-shippingAddress-edit-region input").attr("disabled",!0)},o.handleSelectDefaultShippingAddress=function(e){o.selectDefaultShippingAddress(e),o.isUserProfileDefaultAddressEdited(!0)},o.handleRemoveShippingAddress=function(e){o.user().shippingAddressBook.remove(e),o.user().deleteShippingAddress(!0),e.isDefaultAddress()&&o.user().shippingAddressBook().length>0&&o.selectDefaultShippingAddress(o.user().shippingAddressBook()[0]),o.user().shippingAddressBook().length===0&&$.Topic(t.topicNames.USER_PROFILE_ADDRESSES_REMOVED).publish(),o.handleUpdateProfileForAddressBook()},o.selectDefaultShippingAddress=function(e){o.user().selectDefaultAddress(e)},o.handleUpdateProfileForAddressBook=function(){var e={},n=!1,r=!1,i=!1;o.user().editShippingAddress()!=null&&($.inArray(o.user().editShippingAddress(),o.user().shippingAddressBook())<0&&o.user().shippingAddressBook.push(o.user().editShippingAddress()),o.user().shippingAddressBook().length===1&&o.user().shippingAddressBook()[0].isDefaultAddress(!0),o.user().editShippingAddress().isDefaultAddress()&&o.user().selectDefaultAddress(o.user().editShippingAddress()));if(o.user().isShippingAddressBookModified()){for(var s=0;s<o.user().shippingAddressBook().length;s++)if(!o.user().shippingAddressBook()[s].validateNow()){n=!0;break}i=!n,r=!0}if(!r){$.Topic(t.topicNames.USER_PROFILE_UPDATE_NOCHANGE).publish();return}if(n){$.Topic(t.topicNames.USER_PROFILE_UPDATE_INVALID).publish();return}i&&o.user().handleShippingAddressUpdate(e),o.user().invokeUpdateProfile(e)},o.handleModalUpdateProfile=function(){l(!0);if(o.user().isSearchInitiatedWithUnsavedChanges()){o.handleUpdateProfileForAddressBook(),o.hideModal(),o.user().isSearchInitiatedWithUnsavedChanges(!1);return}f!="CC-loginHeader-myAccount"&&o.user().delaySuccessNotification(!0),o.handleUpdateProfileForAddressBook()},$.Topic(t.topicNames.USER_PROFILE_UPDATE_NOCHANGE).subscribe(function(){o.showViewProfile(!1),o.hideModal()}),$.Topic(t.topicNames.USER_PROFILE_SESSION_RESET).subscribe(function(){o.showViewProfile(!1),o.hideModal()}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_INVALID).subscribe(function(){i.sendError(o.WIDGET_ID,o.ErrorMsg,!0),l()&&(o.isUserProfileInvalid(!0),l(!1)),o.user().delaySuccessNotification(!1),o.hideModal()}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_SUCCESSFUL).subscribe(function(){o.user().isUserProfileEdited(!1),o.showViewProfile(!0),i.clearError(o.WIDGET_ID),i.clearSuccess(o.WIDGET_ID),o.user().delaySuccessNotification()||i.sendSuccess(o.WIDGET_ID,o.translate("updateSuccessMsg"),!0),o.hideModal(),l()&&(l(!1),o.navigateAway())}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_FAILURE).subscribe(function(e){l()&&(o.isUserProfileInvalid(!0),l(!1)),o.user().delaySuccessNotification(!1),o.hideModal();if(e.status==s.HTTP_UNAUTHORIZED_ERROR)o.user().isSessionExpiredDuringSave(!0),n.doLogin(n.getPath());else{var t=o.passwordErrorMsg;i.clearError(o.WIDGET_ID),i.clearSuccess(o.WIDGET_ID),e.errorCode===s.USER_PROFILE_INTERNAL_ERROR?(t=e.message,o.user().getCurrentUser(!1),o.reloadShipping()):e.errors&&e.errors.length>0&&e.errors[0].errorCode===s.USER_PROFILE_SHIPPING_UPDATE_ERROR?t=e.errors[0].message:t=e.message,i.sendError(o.WIDGET_ID,t,!0),o.hideModal()}}),$.Topic(t.topicNames.USER_LOAD_SHIPPING).subscribe(function(){o.reloadShipping()}),$.Topic(t.topicNames.UPDATE_USER_LOCALE_NOT_SUPPORTED_ERROR).subscribe(function(){o.isProfileLocaleNotInSupportedLocales(!0)}),o.navigateAway=function(){if(f==="CC-header-checkout"||f==="CC-loginHeader-logout"||f==="CC-customerAccount-view-orders"||f==="CC-header-language-link"||f.indexOf("CC-header-languagePicker")!=-1){o.removeEventHandlersForAnchorClick(),o.showViewProfile(!1);var e=$("#"+f).get()[0];e.click()}else if(f==="CC-loginHeader-myAccount"){var e=$("#"+f).get()[0];e.click()}else n.isPathEqualTo(o.interceptedLink)||(n.goTo(o.interceptedLink),o.removeEventHandlersForAnchorClick())};var c=function(e,t){var n=t&&t.usingCCLink;o.isProfileLocaleNotInSupportedLocales(!1);if(o.user().loggedIn()){f=this.id,o.interceptedLink=e.currentTarget.pathname;if(o.isUserProfileShippingEdited()||o.isUserProfileDefaultAddressEdited())return o.showModal(),n&&(t.preventDefault=!0),!1;o.showViewProfile(!1)}},h=function(e){o.isProfileLocaleNotInSupportedLocales(!1)};o.addEventHandlersForAnchorClick=function(){$("body").on("click.cc.unsaved","a",c),$("body").on("mouseleave",h)},o.removeEventHandlersForAnchorClick=function(){$("body").off("click.cc.unsaved","a",c)}}}})