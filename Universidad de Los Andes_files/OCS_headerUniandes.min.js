define(["knockout","pubsub","notifications","CCi18n","ccConstants","navigation","ccLogger","jquery","ccNumber"],function(e,t,n,r,i,s,o,u,a){"use strict";var f;return{linkList:e.observableArray(),WIDGET_ID:"header",cartVisible:e.observable(!1),ignoreBlur:e.observable(!1),deleteData:e.observable(!1),nameStudent:e.observable(),displayMenu:function(){u(".menu-toggle").toggleClass("open")},beforeAppear:function(){f.loaded(!0)},closeModalUser:function(){window.setTimeout(function(){u(".modal-backdrop").remove()},500)},closeModalCookies:function(){window.setTimeout(function(){location.reload()},100)},onLoad:function(n){f=n;var a=document.createElement("iframe");a.style.display="none",a.src="https://mindmup.github.io/3rdpartycookiecheck/start.html",document.body.appendChild(a);var l=function(e){setTimeout(function(){e.data==="MM:3PCunsupported"?(console.log("No supported"),u("#enabledThirdPartyCookie").modal("show")):e.data==="MM:3PCsupported"&&console.log("supported"),u('iframe[src="https://mindmup.github.io/3rdpartycookiecheck/start.html"]').remove()},200)};window.addEventListener("message",l,!1);var c=!1;o.info("on header load cart contains "+n.cart().items().length),n.linkList.removeAll(),u.Topic(t.topicNames.USER_PROFILE_LOADED).subscribe(function(e){console.log("cargada la data del usuario",e)}),u.Topic(t.topicNames.PAGE_READY).subscribe(function(e){if(e.path!=="home"&&f.user().loggedIn()){var t=n.user().dynamicProperties(),r=0,i=!1;for(var o=0;o<t.length;o++){switch(t[o].id()){case"OCS_TipoIdentificacion":var a=t[o].value();r++;break;case"OCS_NumeroIdentificacion":t[o].value()||(i=!0),r++;break;case"OCS_IDTypeOCC":var l=t[o].value();r++;break;case"OCS_CodigoEstudiante":t[o].value()||(i=!0),r++;break;case"OCS_Facultad":t[o].value()||(i=!0),r++;break;case"OCS_ProgramaAcademico":t[o].value()||(i=!0),r++;break;case"OCS_FechaExpedicionDocumento":var c=t[o].value();r++}if(r>=7)break}if(!c||i)window.setTimeout(function(){u("#errorUserData").modal("show")},500),s.goTo("profile");l&&l!==a&&(window.setTimeout(function(){u("#errorUserData").modal("show")},500),s.goTo("profile"))}else e.path==="home"&&f.user().loggedIn()&&window.scroll(0,0)}),u.Topic(t.topicNames.CART_LOADED_FOR_PROFILE).subscribe(function(){var e=n.user().dynamicProperties(),t=0,r=!1;for(var i=0;i<e.length;i++){switch(e[i].id()){case"OCS_TipoIdentificacion":var o=e[i].value();t++;break;case"OCS_NumeroIdentificacion":e[i].value()||(r=!0),t++;break;case"OCS_IDTypeOCC":var a=e[i].value();t++;break;case"OCS_CodigoEstudiante":e[i].value()||(r=!0),t++;break;case"OCS_Facultad":e[i].value()||(r=!0),t++;break;case"OCS_ProgramaAcademico":e[i].value()||(r=!0),t++;break;case"OCS_FechaExpedicionDocumento":var f=e[i].value();t++}if(t>=7)break}if(!f||r)window.setTimeout(function(){u("#errorUserData").modal("show")},500),s.goTo("profile");a&&a!==o&&(window.setTimeout(function(){u("#errorUserData").modal("show")},500),s.goTo("profile")),u.Topic("DELETE_ALL_DATA_CART").publish(!0)}),u.Topic(t.topicNames.SAML_LOGIN_SUCCESSFUL).subscribe(function(e){window.setTimeout(function(){n.user().readyToDisplay(!1),n.nameStudent(n.user().firstName());for(var e=0;e<n.user().dynamicProperties().length;e++)if(n.user().dynamicProperties()[e].id()==="OCS_NombresIdentitarios"&&n.user().dynamicProperties()[e].value()){n.nameStudent(n.user().dynamicProperties()[e].value());break}console.log("widget",n.nameStudent()),n.user().readyToDisplay(!0)},500),u.Topic("DELETE_ALL_DATA_CART").publish(!0)}),u.Topic("DELETE_ALL_DATA_CART").subscribe(function(e){for(var r=0;r<n.cart().items().length;r++)if(n.cart().items()[r].productData()&&(n.cart().items()[r].productData().type==="PlandePagos"||n.cart().items()[r].productData().type==="Matricula")){n.deleteData(e),u.Topic(t.topicNames.CART_REMOVE).publishWith(n.cart().items()[r].productData(),[{message:"success",commerceItemId:n.cart().items()[r].commerceItemId}]);break}}),u.Topic(t.topicNames.CART_REMOVE_SUCCESS).subscribe(function(){var e=function(){for(var e=0;e<n.cart().items().length;e++)if(n.cart().items()[e].productData().type==="PlandePagos"||n.cart().items()[e].productData().type==="Matricula")return!1;return!0};e()&&n.deleteData(!1)}),n.deleteData(!1),n.cart().allItems.subscribe(function(e){if(e.length==n.cart().items().length&&n.deleteData())for(var r=0;r<n.cart().items().length;r++)if((n.cart().items()[r].productData().type==="PlandePagos"||n.cart().items()[r].productData().type==="Matricula")&&n.deleteData()){u.Topic(t.topicNames.CART_REMOVE).publishWith(n.cart().items()[r].productData(),[{message:"success",commerceItemId:n.cart().items()[r].commerceItemId}]);break}});for(var h in n.links())n.linkList.push(n.links()[h]);n.cartLinkText=e.computed(function(){var e,t,i,s=n.cart().currency.symbol,e=n.formatPrice(n.cart().subTotal(),n.cart().currency.fractionalDigits);return s.match(/^[0-9a-zA-Z]+$/)&&(s+=" "),i=n.ccNumber(n.cart().numberOfItems()),t=r.t("ns.common:resources.cartDropDownText",{count:n.cart().numberOfItems(),formattedCount:i,currency:s,totalPrice:e}),t},n);var p=navigator.userAgent.match(i.IPAD_STRING)!=null;p&&u(window).on("touchend",function(e){u(e.target).closest("#dropdowncart").length||(u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active")),u(e.target).closest("#languagedropdown").length||(u("#languagedropdown > .content").fadeOut("slow"),u("#languagedropdown").removeClass("active"));if(!!u(e.target).closest("#CC-megaMenu").length)return u(e.target).closest("a").next("ul").length===0?!0:!c&&u(window).width()>=i.VIEWPORT_TABLET_UPPER_WIDTH?(c=!0,!1):c&&u(e.target).closest("a").attr("href")===s.getRelativePath()?!1:!0;u("li.cc-desktop-dropdown:hover > ul.dropdown-menu").css("display","none"),c=!1})},keypressHandler:function(e,t){var n,r,s;n=this,r=u(t.target),s=t.which?t.which:t.keyCode,t.shiftKey&&s==i.KEY_CODE_TAB&&(s=i.KEY_CODE_SHIFT_TAB);switch(s){case i.KEY_CODE_TAB:r[0].id!=="CC-header-cart-total"&&(this.handleCartClosedAnnouncement(),u("#dropdowncart").removeClass("active"));break;case i.KEY_CODE_SHIFT_TAB:r[0].id==="CC-header-cart-total"&&(this.handleCartClosedAnnouncement(),u("#dropdowncart").removeClass("active"))}return!0},showDropDownCart:function(){this.cartOpenTimeout&&clearTimeout(this.cartOpenTimeout),this.cartVisible(!0),u("#CC-header-cart-total").attr("aria-label",r.t("ns.common:resources.miniCartOpenedText")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.common:resources.miniCartOpenedText")),n.emptyGrowlMessages(),this.computeDropdowncartHeight(),this["header-dropdown-minicart"].currentSection(1),this.computeMiniCartItems(),u("#dropdowncart").addClass("active"),u("#dropdowncart > .content").fadeIn("slow");var e=this;u(document).on("mouseleave","#dropdowncart",function(){e.handleCartClosedAnnouncement(),u("#dropdowncart > .content").fadeOut("slow"),u(this).removeClass("active")});var t=navigator.userAgent.match(i.IPAD_STRING)!=null;t&&u(document).on("touchend",function(t){u(t.target).closest("#dropdowncart").length||(e.handleCartClosedAnnouncement(),u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active"))})},hideDropDownCart:function(){return this.cartVisible(!1),u("#CC-header-cart-total").attr("aria-label",r.t("ns.common:resources.miniCartClosedText")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.common:resources.miniCartClosedText")),setTimeout(function(){u("#CC-header-cart-total").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle"))},1e3),u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active"),this.cartOpenTimeout&&clearTimeout(this.cartOpenTimeout),!0},toggleDropDownCart:function(){u("#dropdowncart").hasClass("active")?this.hideDropDownCart():this.showDropDownCart()},handleRemoveFromCart:function(){u.Topic(t.topicNames.CART_REMOVE).publishWith(this.cartItem.productData(),[{message:"success",commerceItemId:this.cartItem.commerceItemId,shippingGroup:this.shippingGroupRelationship}])},handlePlaceHolderRemove:function(){u.Topic(t.topicNames.PLACE_HOLDER_REMOVE).publish(this)},handleValidateCart:function(e,n){if(e.user().isUserProfileEdited())return!0;e.cart().validatePrice=!0,s.getRelativePath()==e.links().cart.route&&e.cart().skipPriceChange(!0),u.Topic(t.topicNames.LOAD_CHECKOUT).publishWith(e.cart(),[{message:"success"}])},handleDropDownCheckout:function(e,t){this.hideDropDownCart(),this.handleValidateCart(e,t)},skipToContentHandler:function(){var e,t,n=this;for(t=0;t<n.length;t++)if(n[t].type()===i.REGION_TYPE_BODY)break;t==n.length?e=u("#main .row .redBox div:first-child").attr("id"):e="region-"+n[t].name();var r="#"+e+" :focusable";r&&u(r).first().focus()},processNrParameter:function(e,t){if(e.indexOf("(")===-1)return e;var n=e.split("(")[1],r=n.split(")")[0],i=r.split(","),s="";for(var o=0;o<i.length;o++){if(i[o].indexOf("product.priceListPair")!==-1&&t==="currency-picker")continue;if(i[o].indexOf("product.language")!==-1&&t==="language-picker")continue;s===""?s=i[o]:s=s+","+i[o]}return s=e.split("(")[0]+"("+s,s=s+")"+e.split(")")[1],s},handleCartClosedAnnouncement:function(){u("#dropdowncart").hasClass("active")&&(u("#alert-modal-change").text(r.t("ns.common:resources.miniCartClosedText")),u("#CC-header-cart-total").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")))}}})