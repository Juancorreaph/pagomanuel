define(["knockout","pubsub","navigation","notifier","ccConstants","CCi18n","swmRestClient","ccResourceLoader!global/OCS_DATA_utils"],function(e,t,n,r,i,s,o,u){"use strict";var a;return{WIDGET_ID:"shopperDetails",ignoreBlur:e.observable(!1),interceptedLink:e.observable(null),isUserProfileInvalid:e.observable(!1),showSWM:e.observable(!0),isProfileLocaleNotInSupportedLocales:e.observable(),emailAlterno:e.observable(),middleName:e.observable(),lastName2:e.observable(),typeId:e.observable(),IdNumber:e.observable(),edoCivil:e.observable(),codStudent:e.observable(),faculty:e.observable(),academicProgram:e.observable(),academicProgram2:e.observable(),phoneNumber:e.observable(),dateExpID:e.observable(),dateExpIDMask:e.observable(),facultyOptions:e.observableArray([]),maritalStatusOptions:e.observableArray([]),idTypeOptions:e.observableArray([]),genderOptions:e.observableArray([]),dateOfBirthMask:e.observable(),clearObs:function(e){e("")},beforeAppear:function(e){var t=this;if(t.user().loggedIn()==0)n.doLogin(n.getPath(),t.links().home.route);else if(t.user().isSessionExpiredDuringSave())t.user().isSessionExpiredDuringSave(!1);else{t.setValuesUser();if(t.user().dateOfBirth()){var i=t.user().dateOfBirth().split("T");t.dateOfBirthMask(i[0])}t.showViewProfile(!0),r.clearError(t.WIDGET_ID),r.clearSuccess(t.WIDGET_ID),$("#inputDateexp").datepicker({format:"dd/mm/yyyy",endDate:"-1d",language:"es",orientation:"bottom auto",autoclose:!0,startDate:"-100y"})}window.setTimeout(function(){$("#inputDateexp").datepicker({format:"dd/mm/yyyy",endDate:"-1d",language:"es",orientation:"bottom auto",autoclose:!0,startDate:"-100y"}),$.Topic("SECTION_INFOTIPS").publish(3),a.loaded(!0)},500)},calendarAppear:function(){$(".datepicker-days").css({"margin-left":"15px","margin-right":"15px"})},setValuesUser:function(){var e=a.user().dynamicProperties(),t=0;for(var n=0;n<e.length;n++){switch(e[n].id()){case"OCS_EmailAlterno":a.emailAlterno(e[n].value()),t++;break;case"OCS_SegundoNombre":a.middleName(e[n].value()),t++;break;case"OCS_SegundoApellido":a.lastName2(e[n].value()),t++;break;case"OCS_TipoIdentificacion":a.typeId(e[n].value()),t++;break;case"OCS_NumeroIdentificacion":a.IdNumber(e[n].value()),t++;break;case"OCS_EstadoCivil":a.edoCivil(e[n].value()),t++;break;case"OCS_CodigoEstudiante":a.codStudent(e[n].value()),t++;break;case"OCS_Facultad":a.faculty(e[n].value()),t++;break;case"OCS_ProgramaAcademico":a.academicProgram(e[n].value()),t++;break;case"OCS_SegundoPrograma":a.academicProgram2(e[n].value()),t++;break;case"OCS_Telefono":a.phoneNumber(e[n].value()),t++;break;case"OCS_FechaExpedicionDocumento":if(e[n].value()){var r=(new Date(e[n].value())).toLocaleDateString();a.dateExpID(r),a.dateExpIDMask(r),t++}else a.dateExpID(null),a.dateExpIDMask(null)}if(t>=12)break}},setValidValuesForUser:function(){var e=a.user().dynamicProperties();for(var t=0;t<e.length;t++)if(e[t].id()==="OCS_FechaExpedicionDocumento"){a.dateExpID(a.dateExpIDMask());var n=a.dateExpID().split("/"),r=Number(n[1])-1,i=new Date(n[2],r,n[0]);e[t].value(i);break}},handleUpdateProfile:function(){console.log("handleUpdateProfile"),a.user().locale("es"),a.setValidValuesForUser(),a.handleUpdateProfileForShopperDetails()},onLoad:function(s){a=s;var f=e.observable(!1),l=e.observable(null),c=e.observable(!1);s.facultyOptions(u.FACULTY_OPTIONS),s.maritalStatusOptions(u.MARITAL_STATUS),s.idTypeOptions(u.ID_TYPE_OPTIONS),s.genderOptions(u.GENDER_OPTIONS),s.errorDataStudent=e.computed(function(){return!a.codStudent()||!a.typeId()||!a.IdNumber()||!a.faculty()||!a.academicProgram()?!0:!1}),s.ErrorMsg=s.translate("updateErrorMsg"),s.passwordErrorMsg=s.translate("passwordUpdateErrorMsg"),s.getProfileLocaleDisplayName=function(){for(var e=0;e<s.user().supportedLocales.length;e++)if(s.user().locale()===s.user().supportedLocales[e].name)return s.user().supportedLocales[e].displayName},s.getFormattedProfileLocaleDisplayName=function(e){return e.name.toUpperCase()+" - "+e.displayName},s.showViewProfile=function(e){e&&s.user().getCurrentUser(!1)},s.handleMouseUp=function(){return this.ignoreBlur(!1),!0},s.handleMouseDown=function(){return this.ignoreBlur(!0),!0},s.hideModal=function(){if(f()||s.user().isSearchInitiatedWithUnsavedChanges())$("#CC-customerProfile-modal-1").modal("hide"),$("body").removeClass("modal-open"),$(".modal-backdrop").remove()},s.showModal=function(){$("#CC-customerProfile-modal-1").modal("show"),f(!0)},s.handleCancelUpdateForShopperDetails=function(){s.showViewProfile(!0),r.clearError(s.WIDGET_ID),r.clearSuccess(s.WIDGET_ID),s.hideModal(),this.user().isUserProfileEdited(!1)},s.handleModalCancelUpdateDiscard=function(){s.handleCancelUpdateForShopperDetails(),s.user().isSearchInitiatedWithUnsavedChanges()?(s.hideModal(),s.user().isSearchInitiatedWithUnsavedChanges(!1)):s.navigateAway()},s.handleUpdateProfileForShopperDetails=function(){var e={},r=!1,i=!1,o=!1,u=!1;s.user().isProfileModified()&&(s.user().isProfileValid()?o=!0:r=!0,i=!0);if(s.user().dynamicProperties().length>0&&s.user().isDynamicPropertiesModified()){for(var a=0;a<s.user().dynamicProperties().length;a++){var f=s.user().dynamicProperties()[a];if(!f.isValid()){r=!0;break}}r||(u=!0),i=!0}if(!i){$.Topic(t.topicNames.USER_PROFILE_UPDATE_NOCHANGE).publish();return}if(r){$.Topic(t.topicNames.USER_PROFILE_UPDATE_INVALID).publish();return}o&&s.user().handleAccountDetailsUpdate(e),u&&s.user().handleDynamicPropertiesUpdate(e),s.user().invokeUpdateProfile(e),n.goTo("/home")},s.handleModalUpdateProfile=function(){c(!0);if(s.user().isSearchInitiatedWithUnsavedChanges()){s.handleUpdateProfileForShopperDetails(),s.hideModal(),s.user().isSearchInitiatedWithUnsavedChanges(!1);return}l!="CC-loginHeader-myAccount"&&s.user().delaySuccessNotification(!0),s.handleUpdateProfileForShopperDetails()},$.Topic(t.topicNames.USER_PROFILE_UPDATE_NOCHANGE).subscribe(function(){s.showViewProfile(!1),s.hideModal(),s.user().isUserProfileEdited(!1)}),$.Topic(t.topicNames.USER_PROFILE_SESSION_RESET).subscribe(function(){s.showViewProfile(!1),s.hideModal(),a.user().isUserProfileEdited(!1)}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_INVALID).subscribe(function(){r.sendError(s.WIDGET_ID,s.ErrorMsg,!0),c()&&(s.isUserProfileInvalid(!0),c(!1)),s.user().delaySuccessNotification(!1),s.hideModal()}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_SUCCESSFUL).subscribe(function(){s.user().isUserProfileEdited(!1);if(s.displaySWM){var e=function(e){$.Topic(t.topicNames.SOCIAL_SPACE_SELECT).publish(),$.Topic(t.topicNames.SOCIAL_SPACE_MEMBERS_INFO_CHANGED).publish()},n=function(e,t,n){},i={};s.user().emailMarketingMails()?i={firstName:s.user().firstName(),lastName:s.user().lastName()}:i={firstName:s.user().firstName(),lastName:s.user().lastName(),notifyCommentFlag:"0",notifyNewMemberFlag:"0"},o.request("PUT","/swm/rs/v1/sites/{siteid}/users/{userid}",i,e,n,{userid:o.apiuserid})}s.showViewProfile(!0),r.clearError(s.WIDGET_ID),r.clearSuccess(s.WIDGET_ID),s.user().delaySuccessNotification()||r.sendSuccess(s.WIDGET_ID,s.translate("updateSuccessMsg"),!0),s.hideModal(),c()&&(c(!1),s.navigateAway()),$.Topic(t.topicNames.DISCARD_ADDRESS_CHANGES).publish()}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_FAILURE).subscribe(function(e){c()&&(s.isUserProfileInvalid(!0),c(!1)),s.user().delaySuccessNotification(!1),s.hideModal();if(e.status==i.HTTP_UNAUTHORIZED_ERROR)s.user().isSessionExpiredDuringSave(!0),n.doLogin(n.getPath());else{var o=s.passwordErrorMsg;r.clearError(s.WIDGET_ID),r.clearSuccess(s.WIDGET_ID),e.errorCode===i.USER_PROFILE_INTERNAL_ERROR?(o=e.message,s.user().getCurrentUser(!1)):o=e.message,r.sendError(s.WIDGET_ID,o,!0),s.hideModal()}$.Topic(t.topicNames.DISCARD_ADDRESS_CHANGES).publish()}),$.Topic(t.topicNames.UPDATE_USER_LOCALE_NOT_SUPPORTED_ERROR).subscribe(function(){s.isProfileLocaleNotInSupportedLocales(!0)}),$.Topic(t.topicNames.CART_LOADED_FOR_PROFILE).subscribe(function(){a.setValuesUser(),$.Topic("SECTION_INFOTIPS").publish(3),a.showViewProfile(!0),r.clearError(s.WIDGET_ID),r.clearSuccess(s.WIDGET_ID)}),s.navigateAway=function(){if(l==="CC-header-checkout"||l==="CC-loginHeader-logout"||l==="CC-customerAccount-view-orders"||l==="CC-header-language-link"||l.indexOf("CC-header-languagePicker")!=-1){s.removeEventHandlersForAnchorClick(),s.showViewProfile(!1);var e=$("#"+l).get()[0];e.click()}else if(l==="CC-loginHeader-myAccount"){var e=$("#"+l).get()[0];e.click()}else n.isPathEqualTo(s.interceptedLink)||(n.goTo(s.interceptedLink),s.removeEventHandlersForAnchorClick())};var h=function(e,t){var n=t&&t.usingCCLink;s.isProfileLocaleNotInSupportedLocales(!1);if(s.user().loggedIn()){l=this.id,s.interceptedLink=e.currentTarget.pathname;if(s.user().isUserProfileEdited())return s.showModal(),n&&(t.preventDefault=!0),!1;s.showViewProfile(!1)}},p=function(e){s.isProfileLocaleNotInSupportedLocales(!1)};s.inputFieldFocused=function(e,t){return this.user().isUserProfileEdited(!0),!0},s.addEventHandlersForAnchorClick=function(){$("body").on("click.cc.unsaved","a",h),$("body").on("mouseleave",p)},s.removeEventHandlersForAnchorClick=function(){$("body").off("click.cc.unsaved","a",h)}}}})